#!/bin/bash

# Cores para feedback
VERDE='\033[0;32m'
AMARELO='\033[1;33m'
VERMELHO='\033[0;31m'
NC='\033[0m'

# --- Seção de Verificação e Instalação ---

# Verifica se o Java está instalado
if ! command -v java &> /dev/null; then
    echo -e "${AMARELO}[*] Java não encontrado. Instalando OpenJDK 11...${NC}"
    sudo apt update -y && sudo apt upgrade -y
    sudo apt install -y openjdk-11-jre wget
else
    echo -e "${VERDE}[+] Java já está instalado.${NC}"
fi

# Garante que o diretório do Metabase existe e entra nele
echo -e "${AMARELO}[*] Verificando diretório do Metabase...${NC}"
mkdir -p ~/metabase
cd ~/metabase

# Verifica se o metabase.jar existe, se não, baixa ele
if [ ! -f "metabase.jar" ]; then
    echo -e "${AMARELO}[*] Baixando o Metabase v0.49.12...${NC}"
    wget -q https://downloads.metabase.com/v0.49.12/metabase.jar -O metabase.jar
    if [ $? -eq 0 ]; then
        echo -e "${VERDE}[+] Download do Metabase concluído.${NC}"
    else
        echo -e "${VERMELHO}[-] Falha no download do Metabase. Verifique sua conexão.${NC}"
        exit 1
    fi
else
    echo -e "${VERDE}[+] Arquivo metabase.jar já existe.${NC}"
fi

# --- Seção de Execução ---

# Verifica o primeiro argumento passado para o script
if [[ "$1" == "--foreground" || "$1" == "-f" ]]; then
    # Execução em Primeiro Plano (Foreground)
    echo -e "${AMARELO}[*] Iniciando o Metabase em PRIMEIRO PLANO na porta 3000...${NC}"
    echo -e "${AMARELO}[*] Acesse com: http://localhost:3000${NC}"
    echo -e "${AMARELO}[*] Pressione CTRL+C para parar o servidor.${NC}"
    java -jar metabase.jar
else
    # Execução em Segundo Plano (Background) - Padrão
    # Garante que não está rodando antes de iniciar um novo
    if pgrep -f metabase.jar > /dev/null; then
        echo -e "${VERDE}[+] Metabase já está rodando em segundo plano.${NC}"
    else
        echo -e "${AMARELO}[*] Iniciando o Metabase em SEGUNDO PLANO na porta 3000...${NC}"
        nohup java -jar metabase.jar > metabase.log 2>&1 &
        sleep 5 # Dá um tempo para o processo iniciar
        if pgrep -f metabase.jar > /dev/null; then
            echo -e "${VERDE}[+] Metabase foi iniciado com sucesso!${NC}"
            echo -e "${VERDE}[+] Acesse com: http://localhost:3000${NC}"
            echo -e "${VERDE}[+] Log de execução: ~/metabase/metabase.log${NC}"
        else
            echo -e "${VERMELHO}[-] Falha ao iniciar o Metabase. Verifique o log: ~/metabase/metabase.log${NC}"
        fi
    fi
fi